# 车载网络入侵检测系统（NIDPS）需求规格说明书

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档编号 | NIDPS-SPEC-0001 |
| 版本 | v1.0.0 |
| 创建日期 | 2026-01-13 |
| 状态 | 草案 |

---

## 目录

1. [项目概述](#1-项目概述)
2. [系统架构设计](#2-系统架构设计)
3. [开发环境搭建](#3-开发环境搭建)
4. [测试环境搭建](#4-测试环境搭建)
5. [开源合规与GPL规避设计](#5-开源合规与gpl规避设计)
6. [功能需求](#6-功能需求)
7. [规则配置系统](#7-规则配置系统)
8. [日志存储系统](#8-日志存储系统)
9. [安全事件代号定义](#9-安全事件代号定义)
10. [接口规范](#10-接口规范)
11. [性能要求](#11-性能要求)
12. [附录](#附录)

---

## 1. 项目概述

### 1.1 项目背景

随着智能网联汽车的快速发展，车载网络安全面临越来越多的威胁。本项目基于开源入侵检测引擎Suricata，开发一套适用于车载ARMv8架构平台的网络入侵检测与防御系统（Network Intrusion Detection and Prevention System，NIDPS）。

### 1.2 项目目标

- 基于Suricata开源引擎构建车载网络入侵检测系统
- 支持ARMv8（ARM64/AArch64）架构车载平台
- 实现对2-7层网络协议的深度检测
- 支持车载专用协议（SomeIP、DoIP等）的深度包检测
- 确保开源合规，规避GPL许可证传染风险
- 提供灵活的规则配置和完善的日志存储机制

### 1.3 适用范围

本系统适用于以下场景：
- 智能网联汽车车载网关
- T-Box（Telematics Box）
- 车载域控制器
- 车载防火墙设备

### 1.4 术语定义

| 术语 | 定义 |
|------|------|
| NIDPS | Network Intrusion Detection and Prevention System，网络入侵检测与防御系统 |
| DPI | Deep Packet Inspection，深度包检测 |
| Suricata | 开源的高性能网络IDS/IPS引擎 |
| SomeIP | Scalable service-Oriented MiddlewarE over IP，车载服务导向中间件协议 |
| DoIP | Diagnostics over IP，基于IP的诊断协议 |
| GPL | GNU General Public License，GNU通用公共许可证 |
| IPC | Inter-Process Communication，进程间通信 |

---

## 2. 系统架构设计

### 2.1 总体架构

系统采用进程隔离架构，将GPL许可的Suricata引擎与私有业务代码分离：

```
┌─────────────────────────────────────────────────────────────────┐
│                        车载NIDPS系统                             │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                  私有代码层（非GPL）                       │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐ │   │
│  │  │ 管理控制台   │ │ 规则管理器  │ │ 日志分析处理器       │ │   │
│  │  └─────────────┘ └─────────────┘ └─────────────────────┘ │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐ │   │
│  │  │ 事件处理器   │ │ 告警管理器  │ │ 配置管理器          │ │   │
│  │  └─────────────┘ └─────────────┘ └─────────────────────┘ │   │
│  └──────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                    IPC通信边界（进程隔离）                        │
│              ┌───────────────┼───────────────┐                  │
│              │               │               │                  │
│         Unix Socket    文件监控     命令行调用                   │
│              │               │               │                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                  GPL组件层（Suricata引擎）                 │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐ │   │
│  │  │ 包捕获模块   │ │ 协议解析器  │ │ 规则匹配引擎         │ │   │
│  │  └─────────────┘ └─────────────┘ └─────────────────────┘ │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐ │   │
│  │  │ DPI引擎     │ │ 日志输出    │ │ EVE JSON输出        │ │   │
│  │  └─────────────┘ └─────────────┘ └─────────────────────┘ │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 组件说明

#### 2.2.1 GPL组件层（Suricata引擎）
- **包捕获模块**：基于AF_PACKET或libpcap捕获网络数据包
- **协议解析器**：解析2-7层网络协议
- **规则匹配引擎**：基于Suricata规则语法进行特征匹配
- **DPI引擎**：深度包检测，支持应用层协议解析
- **日志输出**：输出EVE JSON格式日志文件

#### 2.2.2 私有代码层（非GPL）
- **管理控制台**：提供系统管理界面和API
- **规则管理器**：管理入侵检测规则的增删改查
- **日志分析处理器**：解析和处理Suricata输出的日志
- **事件处理器**：处理安全事件，生成告警
- **告警管理器**：管理告警的分发和通知
- **配置管理器**：管理系统配置

---

## 3. 开发环境搭建

### 3.1 宿主机环境要求

| 项目 | 要求 |
|------|------|
| 操作系统 | Ubuntu 20.04/22.04 LTS (x86_64) |
| 内存 | ≥ 8GB |
| 磁盘空间 | ≥ 50GB |
| 网络 | 可访问外网 |

### 3.2 开发工具链

#### 3.2.1 基础开发工具
```bash
# 安装基础开发工具
sudo apt-get update
sudo apt-get install -y \
    build-essential \
    git \
    cmake \
    pkg-config \
    autoconf \
    automake \
    libtool \
    python3 \
    python3-pip \
    python3-yaml
```

#### 3.2.2 ARM64交叉编译工具链
```bash
# 安装ARM64交叉编译器
sudo apt-get install -y \
    gcc-aarch64-linux-gnu \
    g++-aarch64-linux-gnu \
    binutils-aarch64-linux-gnu

# 验证安装
aarch64-linux-gnu-gcc --version
```

### 3.3 Suricata依赖库

#### 3.3.1 必需依赖
```bash
# 安装Suricata依赖库
sudo apt-get install -y \
    libpcre3-dev \
    libpcap-dev \
    libnet1-dev \
    libyaml-dev \
    zlib1g-dev \
    libmagic-dev \
    libjansson-dev \
    libnss3-dev \
    libnspr4-dev \
    liblz4-dev \
    rustc \
    cargo
```

#### 3.3.2 ARM64交叉编译依赖
需要为ARM64目标平台准备对应的库文件：

```bash
# 创建ARM64 sysroot目录
mkdir -p /opt/arm64-sysroot

# 下载或交叉编译ARM64版本的依赖库
# 包括：libpcre, libpcap, libyaml, libjansson, zlib等
```

### 3.4 Suricata源码获取

```bash
# 克隆Suricata源码
git clone https://github.com/OISF/suricata.git
cd suricata
git checkout suricata-7.0.3  # 使用稳定版本

# 更新子模块
git submodule update --init --recursive
```

### 3.5 IDE配置建议

推荐使用以下IDE进行开发：
- **VSCode** + Remote-SSH扩展
- **CLion** + 远程开发功能

配置交叉编译工具链路径和sysroot。

---

## 4. 测试环境搭建

### 4.1 ARM64 Docker测试环境

#### 4.1.1 安装QEMU用户态模拟
```bash
# 安装QEMU用户态模拟支持
sudo apt-get install -y qemu-user-static binfmt-support

# 注册QEMU二进制格式
docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
```

#### 4.1.2 创建ARM64测试容器镜像

Dockerfile（Dockerfile.arm64-test）：
```dockerfile
FROM arm64v8/ubuntu:22.04

# 安装运行时依赖
RUN apt-get update && apt-get install -y \
    libpcre3 \
    libpcap0.8 \
    libyaml-0-2 \
    libjansson4 \
    zlib1g \
    libmagic1 \
    libnss3 \
    libnspr4 \
    liblz4-1 \
    tcpdump \
    iproute2 \
    net-tools \
    && rm -rf /var/lib/apt/lists/*

# 创建工作目录
WORKDIR /opt/nidps

# 创建必要目录
RUN mkdir -p /var/log/suricata \
    /var/lib/suricata \
    /etc/suricata/rules

# 设置环境变量
ENV LD_LIBRARY_PATH=/opt/nidps/lib

ENTRYPOINT ["/bin/bash"]
```

#### 4.1.3 构建和运行测试容器
```bash
# 构建ARM64测试镜像
docker build -t nidps-arm64-test:latest -f Dockerfile.arm64-test .

# 运行测试容器
docker run -it --rm \
    --platform linux/arm64 \
    --network host \
    --cap-add NET_ADMIN \
    --cap-add NET_RAW \
    -v $(pwd)/build/arm64:/opt/nidps \
    -v $(pwd)/config:/etc/suricata \
    -v $(pwd)/logs:/var/log/suricata \
    nidps-arm64-test:latest
```

### 4.2 交叉编译流程

#### 4.2.1 创建交叉编译脚本

```bash
#!/bin/bash
# build-arm64.sh

export CC=aarch64-linux-gnu-gcc
export CXX=aarch64-linux-gnu-g++
export AR=aarch64-linux-gnu-ar
export STRIP=aarch64-linux-gnu-strip
export HOST=aarch64-linux-gnu
export BUILD_DIR=$(pwd)/build/arm64
export SYSROOT=/opt/arm64-sysroot

mkdir -p $BUILD_DIR

# 配置Suricata交叉编译
cd suricata
./configure \
    --host=$HOST \
    --prefix=$BUILD_DIR \
    --sysconfdir=/etc/suricata \
    --localstatedir=/var \
    --with-sysroot=$SYSROOT \
    --enable-nfqueue=no \
    --enable-lua=no \
    --enable-geoip=no \
    CFLAGS="-O2 -march=armv8-a" \
    LDFLAGS="-L$SYSROOT/lib"

# 编译
make -j$(nproc)

# 安装到BUILD_DIR
make install DESTDIR=$BUILD_DIR
```

### 4.3 功能验证测试

#### 4.3.1 基础功能测试
```bash
# 在ARM64容器中执行

# 1. 验证二进制是否正确编译
file /opt/nidps/bin/suricata
# 输出应包含: ELF 64-bit LSB executable, ARM aarch64

# 2. 检查Suricata版本
/opt/nidps/bin/suricata --build-info

# 3. 验证规则加载
/opt/nidps/bin/suricata -T -c /etc/suricata/suricata.yaml

# 4. 使用pcap文件进行离线测试
/opt/nidps/bin/suricata -r /path/to/test.pcap -c /etc/suricata/suricata.yaml
```

#### 4.3.2 协议检测测试
创建测试用例验证各协议检测功能：
- HTTP流量测试
- TLS流量测试
- DNS流量测试
- SomeIP流量测试
- DoIP流量测试

---

## 5. 开源合规与GPL规避设计

### 5.1 GPL传染风险分析

Suricata采用GPL v2许可证，根据GPL条款：
- 修改GPL代码需要开源
- 与GPL代码静态链接需要开源
- 与GPL代码动态链接存在传染风险

### 5.2 GPL规避架构策略

采用**进程隔离 + 标准IPC通信**的架构设计：

#### 5.2.1 隔离原则
1. **进程边界隔离**：私有代码与Suricata运行在独立进程
2. **通信接口标准化**：使用业界通用的IPC机制
3. **数据格式中立**：使用JSON等标准数据格式
4. **无代码共享**：不共享任何源代码或二进制库

#### 5.2.2 合规的通信方式

| 通信方式 | 用途 | 合规性 |
|----------|------|--------|
| Unix Socket | 实时事件推送 | ✅ 标准IPC |
| 文件读写 | 日志文件、配置文件 | ✅ 标准文件I/O |
| 命令行调用 | 启动/停止/重载 | ✅ 标准系统调用 |
| 共享内存 | 高性能数据交换 | ✅ 标准POSIX IPC |
| TCP Socket | 网络通信 | ✅ 标准网络协议 |

### 5.3 代码边界定义

#### 5.3.1 GPL组件（需开源或使用原始开源代码）
- Suricata核心引擎（原始二进制，不修改）
- Suricata规则文件
- Suricata配置文件

#### 5.3.2 私有组件（可保持闭源）
- 管理控制台程序
- 日志分析处理程序
- 规则管理工具
- 告警分发服务
- 业务逻辑处理模块

### 5.4 合规实施清单

- [ ] 不修改Suricata源代码，仅使用官方编译版本
- [ ] 私有代码通过独立进程运行
- [ ] 所有通信使用标准IPC机制
- [ ] 不静态/动态链接Suricata库到私有代码
- [ ] 保留GPL组件的许可证声明
- [ ] 提供GPL组件的源代码获取方式

---

## 6. 功能需求

### 6.1 以太网入侵检测

#### 6.1.1 功能描述
解析OSI模型2-7层数据包，根据入侵检测策略进行匹配，生成入侵检测安全日志。

#### 6.1.2 支持的网络层级

| 层级 | 协议 | 检测能力 |
|------|------|----------|
| 第2层（数据链路层） | Ethernet, VLAN, ARP | MAC地址检测、VLAN标签检测 |
| 第3层（网络层） | IPv4, IPv6, ICMP, IGMP | IP地址检测、分片检测 |
| 第4层（传输层） | TCP, UDP, SCTP | 端口检测、连接状态检测 |
| 第5层（会话层） | - | 会话跟踪 |
| 第6层（表示层） | TLS/SSL | 加密协议检测 |
| 第7层（应用层） | HTTP, DNS, TLS, MQTT, SomeIP, DoIP等 | 应用协议深度检测 |

#### 6.1.3 检测策略
- 基于签名的检测（Signature-based）
- 基于协议异常的检测（Protocol Anomaly）
- 基于流量统计的检测（Statistical Analysis）

### 6.2 DPI深度包检测

#### 6.2.1 功能描述
对应用层协议进行深度解析，按照协议字段配置的规则进行检测，产生安全事件日志。

#### 6.2.2 支持的应用层协议

##### 6.2.2.1 车载专用协议

**SomeIP (Scalable service-Oriented MiddlewarE over IP)**
- Service ID检测
- Method ID检测
- Client ID检测
- Session ID检测
- 消息类型检测（Request, Response, Notification, Error）
- 返回码检测
- Payload内容检测

**DoIP (Diagnostics over IP)**
- 协议版本检测
- Payload类型检测
- 诊断消息检测
- 路由激活检测
- 实体状态检测
- 诊断会话检测

##### 6.2.2.2 通用网络协议

**HTTP/HTTPS**
- URL检测
- HTTP方法检测
- 请求头/响应头检测
- Cookie检测
- User-Agent检测
- 请求体/响应体内容检测

**TLS/SSL**
- 版本检测
- 证书检测
- SNI（Server Name Indication）检测
- 加密套件检测
- JA3/JA3S指纹检测

**DNS**
- 查询类型检测
- 域名检测
- DNS隧道检测
- DNS放大攻击检测

**MQTT**
- 客户端ID检测
- Topic检测
- 消息内容检测
- 认证信息检测
- QoS检测

##### 6.2.2.3 其他协议

| 协议 | 检测能力 |
|------|----------|
| FTP | 命令检测、弱密码检测 |
| Telnet | 命令检测、弱密码检测 |
| SSH | 版本检测、认证方式检测 |
| SMTP | 邮件内容检测 |
| GB/T 32960.3 | 电动汽车远程服务与管理协议监控 |

### 6.3 攻击检测功能

#### 6.3.1 TCP攻击检测

| 攻击类型 | 事件代号 | 描述 |
|----------|----------|------|
| TCP Land攻击 | 101 | 源地址与目的地址相同的攻击 |
| TCP SYN Flood攻击 | 102 | 大量SYN请求导致资源耗尽 |
| TCP ACK Flood攻击 | 103 | 大量ACK报文导致资源耗尽 |
| TCP畸形报文攻击 | 104 | TCP标志位异常或无效组合 |
| TCP数据包异常 | 105 | TCP包长度、序列号等异常 |

#### 6.3.2 UDP攻击检测

| 攻击类型 | 事件代号 | 描述 |
|----------|----------|------|
| UDP Flood攻击 | 201 | 大量UDP报文导致资源耗尽 |
| UDP畸形报文攻击 | 202 | UDP包长度、校验和等异常 |
| UDP数据包异常 | 203 | UDP包格式或内容异常 |

#### 6.3.3 ICMP攻击检测

| 攻击类型 | 事件代号 | 描述 |
|----------|----------|------|
| ICMP Flood攻击 | 301 | 大量ICMP报文导致资源耗尽 |
| Large Ping攻击 | 302 | 超大尺寸的Ping包（死亡之Ping） |
| Ping of Death | 303 | 畸形ICMP报文 |

#### 6.3.4 其他攻击检测

| 攻击类型 | 事件代号 | 描述 |
|----------|----------|------|
| IGMP Flood攻击 | 401 | 大量IGMP报文攻击 |
| ARP欺骗 | 402 | ARP缓存投毒攻击 |
| IP分片攻击 | 403 | 恶意IP分片 |

### 6.4 协议监控功能

| 协议监控类型 | 事件代号 | 描述 |
|--------------|----------|------|
| DoIP协议监控 | 211 | DoIP协议异常行为检测 |
| MQTT协议监控 | 212 | MQTT协议异常行为检测 |
| GB/T 32960.3协议监控 | 213 | 国标电动汽车协议监控 |
| SomeIP协议监控 | 214 | SomeIP协议异常行为检测 |

### 6.5 弱密码监控

| 监控类型 | 事件代号 | 描述 |
|----------|----------|------|
| Telnet弱密码监控 | 501 | 检测Telnet弱密码登录尝试 |
| FTP弱密码监控 | 502 | 检测FTP弱密码登录尝试 |
| SSH弱密码监控 | 503 | 检测SSH暴力破解尝试 |

### 6.6 漏洞检测

| 检测类型 | 事件代号 | 描述 |
|----------|----------|------|
| 已知漏洞利用检测 | 601 | 检测已知CVE漏洞利用尝试 |
| Web应用漏洞 | 602 | SQL注入、XSS等Web攻击 |
| 命令注入检测 | 603 | 检测命令注入攻击 |

### 6.7 杂项监控

| 监控类型 | 事件代号 | 描述 |
|----------|----------|------|
| 可疑DNS查询 | 701 | 异常域名解析请求 |
| 异常流量模式 | 702 | 流量统计异常 |
| 协议滥用 | 703 | 协议不正当使用 |

---

## 7. 规则配置系统

### 7.1 规则格式

采用Suricata标准规则语法：

```
action protocol src_ip src_port -> dst_ip dst_port (options)
```

#### 7.1.1 规则示例

**MQTT非法客户端ID检测（事件代号212）**
```
alert mqtt any any -> any any (msg:"MQTT illegal Client ID:e23f53bb221e4d75b362f01936238841"; mqtt.connect.clientid; content:"e23f53bb22"; classtype:misc-attack; sid:5000019; rev:1;)
```

**TCP SYN Flood检测**
```
alert tcp any any -> $HOME_NET any (msg:"TCP SYN Flood Attack Detected"; flags:S; threshold:type both, track by_src, count 100, seconds 10; classtype:attempted-dos; sid:5000001; rev:1;)
```

**DoIP协议监控**
```
alert tcp any any -> any 13400 (msg:"DoIP Diagnostic Session Control"; content:"|02 FD|"; offset:0; depth:2; content:"|80 01|"; offset:2; depth:2; classtype:policy-violation; sid:5000050; rev:1;)
```

**SomeIP协议监控**
```
alert udp any any -> any 30490:30499 (msg:"SOME/IP Suspicious Service Request"; content:"|FF FF|"; offset:0; depth:2; classtype:suspicious-traffic; sid:5000100; rev:1;)
```

### 7.2 规则文件组织

```
/etc/suricata/rules/
├── local.rules           # 本地自定义规则
├── tcp-attacks.rules     # TCP攻击检测规则
├── udp-attacks.rules     # UDP攻击检测规则
├── icmp-attacks.rules    # ICMP攻击检测规则
├── protocol-monitor.rules # 协议监控规则
├── weak-password.rules   # 弱密码检测规则
├── vulnerability.rules   # 漏洞检测规则
├── automotive/           # 车载协议规则
│   ├── someip.rules
│   ├── doip.rules
│   └── gb32960.rules
└── misc.rules            # 杂项规则
```

### 7.3 规则管理接口

#### 7.3.1 规则文件格式要求
- 文件编码：UTF-8
- 行结束符：LF（Unix风格）
- 注释：以#开头

#### 7.3.2 规则热加载
支持通过Unix Socket发送规则重载命令：
```bash
suricatasc -c reload-rules
```

### 7.4 规则配置API

私有管理程序提供RESTful API进行规则管理：

| 接口 | 方法 | 描述 |
|------|------|------|
| /api/rules | GET | 获取所有规则 |
| /api/rules | POST | 添加新规则 |
| /api/rules/{sid} | GET | 获取指定规则 |
| /api/rules/{sid} | PUT | 更新指定规则 |
| /api/rules/{sid} | DELETE | 删除指定规则 |
| /api/rules/reload | POST | 重载规则 |

---

## 8. 日志存储系统

### 8.1 日志类型

#### 8.1.1 EVE JSON日志
Suricata原生JSON格式日志，包含：
- 告警日志（alert）
- 流量日志（flow）
- 协议日志（http, dns, tls, smtp等）
- 统计日志（stats）

#### 8.1.2 安全事件日志
格式化的安全事件日志，便于上层应用处理。

### 8.2 日志格式

#### 8.2.1 EVE JSON示例
```json
{
  "timestamp": "2026-01-13T10:30:45.123456+0800",
  "flow_id": 1234567890,
  "event_type": "alert",
  "src_ip": "192.168.1.100",
  "src_port": 54321,
  "dest_ip": "192.168.1.1",
  "dest_port": 80,
  "proto": "TCP",
  "alert": {
    "action": "allowed",
    "gid": 1,
    "signature_id": 5000019,
    "rev": 1,
    "signature": "MQTT illegal Client ID",
    "category": "Misc Attack",
    "severity": 2
  }
}
```

#### 8.2.2 安全事件日志格式
```json
{
  "event_id": "uuid",
  "event_code": 212,
  "event_name": "MQTT协议监控",
  "timestamp": "2026-01-13T10:30:45.123456+0800",
  "severity": "medium",
  "source": {
    "ip": "192.168.1.100",
    "port": 54321,
    "mac": "AA:BB:CC:DD:EE:FF"
  },
  "destination": {
    "ip": "192.168.1.1",
    "port": 1883
  },
  "protocol": "MQTT",
  "description": "检测到非法MQTT客户端ID",
  "details": {
    "client_id": "e23f53bb221e4d75b362f01936238841",
    "rule_sid": 5000019
  }
}
```

### 8.3 日志存储配置

#### 8.3.1 Suricata日志配置（suricata.yaml）
```yaml
outputs:
  - eve-log:
      enabled: yes
      filetype: regular
      filename: eve.json
      rotate-interval: day
      types:
        - alert:
            payload: yes
            payload-printable: yes
            packet: yes
            metadata: yes
        - anomaly:
            enabled: yes
        - http:
            extended: yes
        - dns:
            query: yes
            answer: yes
        - tls:
            extended: yes
        - flow
        - mqtt
```

#### 8.3.2 日志轮转策略
```yaml
# logrotate配置
/var/log/suricata/*.json {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 640 suricata suricata
    postrotate
        /bin/kill -HUP `cat /var/run/suricata.pid 2>/dev/null` 2>/dev/null || true
    endscript
}
```

### 8.4 日志存储路径

| 日志类型 | 路径 | 说明 |
|----------|------|------|
| EVE JSON | /var/log/suricata/eve.json | Suricata原生日志 |
| 快速日志 | /var/log/suricata/fast.log | 简单告警日志 |
| 安全事件 | /var/log/nidps/events.json | 处理后的事件日志 |
| 统计日志 | /var/log/suricata/stats.log | 性能统计 |

### 8.5 日志清理策略

- 日志保留期限：默认30天
- 磁盘空间阈值：当磁盘使用率超过80%时自动清理最旧日志
- 日志压缩：超过1天的日志自动压缩

---

## 9. 安全事件代号定义

### 9.1 事件代号分配规则

| 代号范围 | 事件类别 |
|----------|----------|
| 100-199 | TCP相关攻击 |
| 200-299 | UDP相关攻击/协议监控 |
| 300-399 | ICMP相关攻击 |
| 400-499 | 其他网络层攻击 |
| 500-599 | 认证相关（弱密码等） |
| 600-699 | 漏洞利用检测 |
| 700-799 | 杂项监控 |

### 9.2 完整事件代号表

| 代号 | 事件名称 | 严重级别 | 描述 |
|------|----------|----------|------|
| 101 | TCP Land攻击 | 高 | 源地址与目的地址相同 |
| 102 | TCP SYN Flood攻击 | 高 | 大量SYN请求 |
| 103 | TCP ACK Flood攻击 | 高 | 大量ACK报文 |
| 104 | TCP畸形报文攻击 | 高 | TCP标志位异常 |
| 105 | TCP数据包异常 | 中 | TCP包格式异常 |
| 201 | UDP Flood攻击 | 高 | 大量UDP报文 |
| 202 | UDP畸形报文攻击 | 高 | UDP包格式异常 |
| 203 | UDP数据包异常 | 中 | UDP包内容异常 |
| 211 | DoIP协议监控 | 中 | DoIP协议异常 |
| **212** | **MQTT协议监控** | **中** | **MQTT协议异常** |
| 213 | GB/T 32960.3协议监控 | 中 | 国标协议异常 |
| 214 | SomeIP协议监控 | 中 | SomeIP协议异常 |
| 301 | ICMP Flood攻击 | 高 | 大量ICMP报文 |
| 302 | Large Ping攻击 | 高 | 超大Ping包 |
| 303 | Ping of Death | 高 | 畸形ICMP报文 |
| 401 | IGMP Flood攻击 | 高 | 大量IGMP报文 |
| 402 | ARP欺骗 | 高 | ARP缓存投毒 |
| 403 | IP分片攻击 | 高 | 恶意IP分片 |
| 501 | Telnet弱密码监控 | 高 | Telnet弱密码 |
| 502 | FTP弱密码监控 | 高 | FTP弱密码 |
| 503 | SSH弱密码监控 | 高 | SSH暴力破解 |
| 601 | 已知漏洞利用 | 严重 | CVE漏洞利用 |
| 602 | Web应用漏洞 | 高 | SQL注入/XSS等 |
| 603 | 命令注入 | 严重 | 命令注入攻击 |
| 701 | 可疑DNS查询 | 中 | 异常DNS请求 |
| 702 | 异常流量模式 | 低 | 流量统计异常 |
| 703 | 协议滥用 | 中 | 协议不正当使用 |

### 9.3 MQTT监控规则示例（事件代号212）

```
# MQTT非法客户端ID检测
alert mqtt any any -> any any (msg:"MQTT illegal Client ID:e23f53bb221e4d75b362f01936238841"; mqtt.connect.clientid; content:"e23f53bb22"; classtype:misc-attack; sid:5000019; rev:1;)

# MQTT未授权连接检测
alert mqtt any any -> any any (msg:"MQTT Unauthorized Connection Attempt"; mqtt.connect.flags; content:"|00|"; classtype:misc-attack; sid:5000020; rev:1;)

# MQTT异常Topic订阅
alert mqtt any any -> any any (msg:"MQTT Suspicious Topic Subscription"; mqtt.subscribe.topic; content:"$SYS"; classtype:policy-violation; sid:5000021; rev:1;)
```

---

## 10. 接口规范

### 10.1 Suricata控制接口

#### 10.1.1 Unix Socket控制
```bash
# Socket路径
/var/run/suricata/suricata-command.socket

# 命令示例
suricatasc -c "command-list"
suricatasc -c "reload-rules"
suricatasc -c "iface-stat eth0"
```

#### 10.1.2 支持的控制命令
| 命令 | 描述 |
|------|------|
| shutdown | 关闭Suricata |
| reload-rules | 重载规则 |
| iface-list | 列出监听接口 |
| iface-stat <iface> | 接口统计 |
| capture-mode | 显示捕获模式 |
| version | 显示版本 |

### 10.2 私有管理接口

#### 10.2.1 RESTful API概览
```
Base URL: http://localhost:8080/api/v1

认证: Bearer Token
Content-Type: application/json
```

#### 10.2.2 接口列表

**系统管理**
| 接口 | 方法 | 描述 |
|------|------|------|
| /system/status | GET | 获取系统状态 |
| /system/start | POST | 启动检测服务 |
| /system/stop | POST | 停止检测服务 |
| /system/restart | POST | 重启检测服务 |

**规则管理**
| 接口 | 方法 | 描述 |
|------|------|------|
| /rules | GET | 获取规则列表 |
| /rules | POST | 添加规则 |
| /rules/{sid} | GET | 获取规则详情 |
| /rules/{sid} | PUT | 更新规则 |
| /rules/{sid} | DELETE | 删除规则 |
| /rules/reload | POST | 重载规则 |

**日志管理**
| 接口 | 方法 | 描述 |
|------|------|------|
| /logs/events | GET | 获取安全事件 |
| /logs/alerts | GET | 获取告警记录 |
| /logs/stats | GET | 获取统计信息 |

### 10.3 文件接口

#### 10.3.1 配置文件
| 文件 | 路径 | 描述 |
|------|------|------|
| 主配置 | /etc/suricata/suricata.yaml | Suricata主配置 |
| 规则目录 | /etc/suricata/rules/ | 规则文件目录 |
| 变量定义 | /etc/suricata/vars.yaml | 变量定义 |

#### 10.3.2 日志文件
| 文件 | 路径 | 描述 |
|------|------|------|
| EVE日志 | /var/log/suricata/eve.json | JSON格式日志 |
| 快速日志 | /var/log/suricata/fast.log | 文本告警日志 |
| 统计日志 | /var/log/suricata/stats.log | 性能统计 |

---

## 11. 性能要求

### 11.1 硬件要求

#### 11.1.1 最低配置
| 项目 | 要求 |
|------|------|
| CPU | ARMv8 4核 |
| 内存 | 2GB |
| 存储 | 8GB |
| 网络 | 100Mbps |

#### 11.1.2 推荐配置
| 项目 | 要求 |
|------|------|
| CPU | ARMv8 8核 |
| 内存 | 4GB |
| 存储 | 32GB |
| 网络 | 1Gbps |

### 11.2 性能指标

| 指标 | 最低要求 | 目标值 |
|------|----------|--------|
| 包处理速率 | 10,000 pps | 100,000 pps |
| 检测延迟 | < 10ms | < 1ms |
| 规则数量支持 | 1,000条 | 10,000条 |
| 内存占用 | < 512MB | < 256MB |
| CPU占用（空闲） | < 5% | < 2% |
| CPU占用（满载） | < 80% | < 50% |

### 11.3 资源优化建议

- 使用AF_PACKET模式替代libpcap提升性能
- 启用多线程工作模式
- 合理配置规则，避免过度复杂的正则表达式
- 定期清理过期日志释放存储空间

---

## 附录

### A. 参考资料

1. Suricata官方文档：https://docs.suricata.io/
2. Suricata规则语法：https://docs.suricata.io/en/latest/rules/
3. GPL许可证条款：https://www.gnu.org/licenses/gpl-2.0.html
4. SomeIP规范：AUTOSAR CP R20-11
5. DoIP规范：ISO 13400
6. GB/T 32960.3-2016：电动汽车远程服务与管理系统技术规范

### B. 规则语法快速参考

```
# 基本格式
action protocol src_ip src_port -> dst_ip dst_port (options)

# action: alert, drop, reject, pass
# protocol: tcp, udp, icmp, ip, http, dns, tls, mqtt等

# 常用选项
msg:"描述信息";           # 告警消息
content:"匹配内容";       # 内容匹配
pcre:"/正则表达式/";      # 正则匹配
sid:规则ID;              # 规则唯一标识
rev:版本;                # 规则版本
classtype:类别;          # 事件分类
threshold:阈值配置;       # 触发阈值
```

### C. 事件严重级别定义

| 级别 | 名称 | 描述 |
|------|------|------|
| 1 | 严重 (Critical) | 系统可能被入侵或遭受严重攻击 |
| 2 | 高 (High) | 高危攻击尝试，需要立即处理 |
| 3 | 中 (Medium) | 可疑活动，需要关注 |
| 4 | 低 (Low) | 一般信息，可能是误报 |

### D. 变更记录

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| v1.0.0 | 2026-01-13 | - | 初始版本 |

---

*文档结束*
